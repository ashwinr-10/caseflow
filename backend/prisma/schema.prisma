// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  ADMIN
  OPERATOR
}

enum CaseCategory {
  TAX
  LICENSE
  PERMIT
}

enum CasePriority {
  LOW
  MEDIUM
  HIGH
}

enum CaseStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  role      UserRole @default(OPERATOR)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  importJobs ImportJob[]
  cases      Case[]
  auditLogs  AuditLog[]

  @@map("users")
}

model ImportJob {
  id          String   @id @default(uuid())
  userId      String
  fileName    String
  totalRows   Int
  successRows Int      @default(0)
  failedRows  Int      @default(0)
  status      String   // "processing", "completed", "failed"
  errorCsvUrl String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  cases Case[]

  @@map("import_jobs")
}

model Case {
  id            String        @id @default(uuid())
  caseId        String        @unique
  applicantName String
  dob           DateTime
  email         String?
  phone         String?
  category      CaseCategory
  priority      CasePriority  @default(LOW)
  status        CaseStatus    @default(PENDING)
  assigneeId    String?
  importJobId   String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  assignee   User?      @relation(fields: [assigneeId], references: [id])
  importJob  ImportJob? @relation(fields: [importJobId], references: [id])
  auditLogs AuditLog[]
  notes      CaseNote[]

  @@index([caseId])
  @@index([status])
  @@index([category])
  @@index([createdAt])
  @@map("cases")
}

model CaseNote {
  id        String   @id @default(uuid())
  caseId   String
  content  String
  userId   String?
  createdAt DateTime @default(now())

  // Relations
  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@map("case_notes")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  caseId    String?
  action    String   // "create", "update", "delete", "import"
  details   Json?
  createdAt DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id])
  case Case? @relation(fields: [caseId], references: [id])

  @@index([userId])
  @@index([caseId])
  @@index([createdAt])
  @@map("audit_logs")
}

